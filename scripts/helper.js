// Helper JavaScript functions for n8n workflow

/**
 * Parse WhatsApp message from Twilio webhook
 * @param {Object} webhookData - Raw webhook data from Twilio
 * @returns {Object} Parsed command data
 */
function parseWhatsAppMessage(webhookData) {
  const body = webhookData.Body || '';
  const from = webhookData.From || '';
  const messageId = webhookData.MessageSid || '';
  
  // Extract command and path
  const command = body.trim().toUpperCase();
  const parts = command.split(' ');
  const action = parts[0];
  const path = parts[1] || '/';
  const destination = parts[2] || '';
  
  console.log(`Message from ${from}: ${body}`);
  
  const validCommands = ['LIST', 'DELETE', 'MOVE', 'SUMMARY', 'HELP'];
  
  if (!validCommands.includes(action)) {
    return {
      from,
      messageId,
      error: true,
      message: `âŒ Unknown command: ${action}\\n\\nSupported commands:\\nðŸ“‹ LIST /folder\\nðŸ—‘ï¸ DELETE /folder/file.txt\\nðŸ“ MOVE /file.txt /destination\\nðŸ“„ SUMMARY /folder\\nâ“ HELP`
    };
  }
  
  return {
    from,
    messageId,
    action,
    path: path.startsWith('/') ? path : '/' + path,
    destination: destination.startsWith('/') ? destination : '/' + destination,
    originalMessage: body,
    error: false
  };
}

/**
 * Format Google Drive file list for WhatsApp response
 * @param {Array} files - Array of Google Drive file objects
 * @param {string} path - Folder path
 * @returns {Object} Formatted response
 */
function formatFileListResponse(files, path) {
  if (files.length === 0) {
    return {
      message: `ðŸ“ Folder: ${path}\\n\\nâŒ No files found or folder doesn't exist.`
    };
  }
  
  let response = `ðŸ“ Folder: ${path}\\n\\n`;
  
  files.forEach((file, index) => {
    const size = file.size ? `(${Math.round(file.size / 1024)}KB)` : '';
    const type = file.mimeType.includes('folder') ? 'ðŸ“' : 'ðŸ“„';
    const modifiedDate = new Date(file.modifiedTime).toLocaleDateString();
    
    response += `${type} ${file.name} ${size}\\n`;
    response += `   Modified: ${modifiedDate}\\n\\n`;
  });
  
  response += `\\nðŸ“Š Total files: ${files.length}`;
  
  return { message: response };
}

/**
 * Format delete confirmation message
 * @param {string} path - File path that was deleted
 * @returns {Object} Formatted response
 */
function formatDeleteResponse(path) {
  const fileName = path.split('/').pop();
  
  return {
    message: `âœ… File deleted successfully!\\n\\nðŸ—‘ï¸ ${fileName}\\n\\nâš ï¸ This action cannot be undone.`
  };
}

/**
 * Format AI summary response
 * @param {Object} summaryData - AI response data
 * @param {string} path - File path
 * @returns {Object} Formatted response
 */
function formatSummaryResponse(summaryData, path) {
  const fileName = path.split('/').pop();
  
  let summary = '';
  if (summaryData.candidates && summaryData.candidates[0]) {
    summary = summaryData.candidates[0].content.parts[0].text;
  }
  
  return {
    message: `ðŸ“„ Summary of: ${fileName}\\n\\n${summary}\\n\\nðŸ¤– Generated by Gemini AI`
  };
}

/**
 * Generate help message
 * @returns {Object} Help message
 */
function generateHelpMessage() {
  const helpMessage = `ðŸ¤– WhatsApp Drive Assistant\\n\\nAvailable Commands:\\n\\nðŸ“‹ LIST /folder\\n   List all files in a folder\\n   Example: LIST /ProjectX\\n\\nðŸ—‘ï¸ DELETE /path/file.ext\\n   Delete a specific file\\n   Example: DELETE /ProjectX/report.pdf\\n\\nðŸ“ MOVE /source /destination\\n   Move file to another location\\n   Example: MOVE /ProjectX/file.pdf /Archive\\n\\nðŸ“„ SUMMARY /path/file.ext\\n   Get AI summary of document\\n   Example: SUMMARY /ProjectX/report.pdf\\n\\nâ“ HELP\\n   Show this help message\\n\\nâš ï¸ Safety Tips:\\nâ€¢ Double-check paths before DELETE\\nâ€¢ Use CONFIRM DELETE for confirmation\\nâ€¢ All actions are logged for audit`;
  
  return { message: helpMessage };
}

/**
 * Create audit log entry
 * @param {Object} commandData - Parsed command data
 * @returns {Object} Audit log entry
 */
function createAuditLogEntry(commandData) {
  const timestamp = new Date().toISOString();
  
  return {
    timestamp,
    from: commandData.from,
    action: commandData.action,
    path: commandData.path,
    success: !commandData.error,
    message: commandData.originalMessage
  };
}

/**
 * Validate file path
 * @param {string} path - File or folder path
 * @returns {boolean} True if valid path
 */
function validatePath(path) {
  // Basic path validation
  if (!path || typeof path !== 'string') {
    return false;
  }
  
  // Check for dangerous patterns
  const dangerousPatterns = ['../', '../', '~/', '/root/', '/etc/'];
  return !dangerousPatterns.some(pattern => path.includes(pattern));
}

/**
 * Extract file ID from Google Drive path
 * @param {string} path - Google Drive file path
 * @returns {string} File ID
 */
function extractFileId(path) {
  // This is a simplified version - in practice, you'd need to
  // maintain a mapping between paths and file IDs
  return path.split('/').pop();
}

/**
 * Get file MIME type for summary compatibility
 * @param {string} fileName - File name
 * @returns {string} MIME type
 */
function getFileMimeType(fileName) {
  const extension = fileName.split('.').pop().toLowerCase();
  
  const mimeTypes = {
    'pdf': 'application/pdf',
    'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
    'doc': 'application/msword',
    'txt': 'text/plain',
    'csv': 'text/csv',
    'md': 'text/markdown'
  };
  
  return mimeTypes[extension] || 'application/octet-stream';
}

/**
 * Check if file is summarizable
 * @param {string} mimeType - File MIME type
 * @returns {boolean} True if file can be summarized
 */
function isSummarizable(mimeType) {
  const summarizableTypes = [
    'application/pdf',
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
    'application/msword',
    'text/plain',
    'text/csv',
    'text/markdown'
  ];
  
  return summarizableTypes.includes(mimeType);
}

/**
 * Sanitize WhatsApp message content
 * @param {string} message - Raw message
 * @returns {string} Sanitized message
 */
function sanitizeMessage(message) {
  // Remove potentially harmful content
  return message
    .replace(/[<>]/g, '') // Remove HTML-like tags
    .replace(/javascript:/gi, '') // Remove javascript URLs
    .substring(0, 1000); // Limit message length
}

// Export functions for use in n8n
module.exports = {
  parseWhatsAppMessage,
  formatFileListResponse,
  formatDeleteResponse,
  formatSummaryResponse,
  generateHelpMessage,
  createAuditLogEntry,
  validatePath,
  extractFileId,
  getFileMimeType,
  isSummarizable,
  sanitizeMessage
};